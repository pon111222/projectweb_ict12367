{% extends "base.html" %}
{% load static %} 

{% block title %}
<title>mikutea - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</title>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="bg-white shadow rounded-4 p-4 mb-4">
    <h2 class="text-center mb-4 text-primary fw-bold">üßã mikutea ‚Äî ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h2>

    {% if orders %}
      <div class="table-responsive">
        <form method="get" class="mb-4 d-flex" role="search">
          <input name="search" type="text" class="form-control me-2" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏°‡∏ô‡∏π..." value="{{ search }}">
          <button type="submit" class="btn btn-primary">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
          <audio id="orderSound" src="{% static 'sounds/ding.mp3' %}" preload="auto"></audio>

<script>
setInterval(function() {
  fetch("{% url 'index' %}")
    .then(response => response.json())
    .then(data => {
      if (data.new_order) {
        document.getElementById('orderSound').play(); // ‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
        alert('üì£ ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!'); // ‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∞‡πÑ‡∏°‡πà alert ‡∏Å‡πá‡πÑ‡∏î‡πâ
        location.reload();
      }
    });
}, 5000); // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥
</script>
        </form>

        <table class="table table-bordered table-hover align-middle">
          <thead class="table-dark text-center">
            <tr>
              <th>‡πÄ‡∏•‡∏Ç‡∏≠‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏≠‡∏£‡πå</th>
              <th>‡πÄ‡∏°‡∏ô‡∏π</th>
              <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</th>
              <th>‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å</th>
              <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
              <th>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              <th>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
            </tr>
          </thead>
          <tbody class="text-center">
            {% for order in orders %}
            <tr>
              <td class="fw-bold text-primary">#{{ order.id }}</td>
              <td class="text-start">
                {% for item in order.items.all %}
                  <div class="d-flex align-items-center gap-2 mb-1">
                    {% if item.menu.image %}
                      <img src="{{ item.menu.image.url }}" width="150" height="130" style="object-fit: cover; border-radius: 8px;">
                    {% endif %}
                    <span>{{ item.menu.name }} x{{ item.quantity }}</span>
                  </div>
                {% endfor %}
              </td>
              <td>{{ order.get_sweetness_display }}</td>
              <td>{{ order.get_pearl_display }}</td>
              <td>{{ order.created_at|date:"d/m/Y H:i" }}</td>
              <td>{{ order.employee.user.username }}</td>
              <td>
                {% for item in order.items.all %}
                  {% if item.is_delivered %}
                    <span class="badge bg-success">‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</span><br>
                  {% else %}
                    <form method="POST" action="{% url 'mark_item_delivered' item.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-sm btn-outline-success">‚úì ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</button>
                    </form>
                  {% endif %}
                {% endfor %}
              </td>
              <td>
                <a href="{% url 'order_edit' order.id %}" class="btn btn-sm btn-outline-warning mb-1">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</a><br>
                <a href="{% url 'order_delete' order.id %}" class="btn btn-sm btn-outline-danger" onclick="return confirm('‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ?');">‡∏•‡∏ö</a>
              </td>
              <td>
                <a href="{% url 'receipt_view' order.id %}" class="btn btn-sm btn-outline-primary">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- üîà Sound effect ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πâ‡∏≤ -->
      <audio id="orderSound" src="{% static 'sounds/ding.mp3' %}" preload="auto"></audio>

      <script>
      setInterval(function() {
        fetch("{% url 'check_new_orders' %}")
          .then(response => response.json())
          .then(data => {
            if (data.new_order) {
              document.getElementById('orderSound').play();
              alert('üì£ ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß!');
              location.reload();
            }
          });
      }, 5000); // ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥
      </script>

    <!-- ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏∞‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ -->
  </div>
</div>


    {% else %}
      <div class="alert alert-warning text-center">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
